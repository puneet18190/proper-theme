<style type="text/css">
/*    .modal-content {
        margin: 15% auto; 
        border: 3px solid #428bca;
        width: 80%; 
    }
    .modal-header-primary {
    background-color: #428bca;
    }*/

/*    tr {
        width: 100%;
        display: inline-table;
        table-layout: fixed;
    }*/
    .call_log table{
        height:300px;              
    }
    .call_log tbody{
        overflow-y: scroll;      
        height: 320px;            
        width: 100%;
        position: absolute;
    }
</style>

<% data = HTTParty.get("http://www.sealproperties.co.uk/get_phone_data")["data"] %>
<ul id="example-1" class="sticklr">
    <li>
        <a href="#">Call Log</a>
        <ul>
            <li class="call_log">
                <table class="table">
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Caller ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Call Duration</th>
                    </tr>

                    <% data.reverse.each do |obj| %>
                        <tr>
                            <td><%=obj["created_at"].to_time.strftime("%D")%></td>
                            <td><%=obj["created_at"].to_time.strftime("%T")%></td>
                            <td><a id="a_select" class="example-p-2"  href="#"><%=obj["callerid"][0]=="0" ? obj["callerid"].gsub(/^0/, "+44") : "+44"+obj["callerid"] unless obj["callerid"].blank?%></a></td>
                            <td><%=obj["name"]%></td>
                            <td><%=obj["department"]%></td>
                            <td><%=obj["status"]%></td>
                            <td><%=Time.at(obj['call_duration']).utc.strftime("%H:%M:%S") %></td>
                        </tr>
                    <%end%>
                </table>
            </li>
        </ul>
    </li>

    <li>
        <a href="#" id="call_handler">Call Handler</a>
        <ul>
            <li>
                <%#user = User.where("mobile = ? OR phone =?", data.last["callerid"],data.last["callerid"]).first%>
                <%#user = User.last%>
            </li>
        </ul>
    </li>
    <li>
        <a href="#">Message</a>
        <ul>
            <li>
                <div class="container" style="padding: 30px">
                    <div class="alert_msg" style="color: red"></div>
                    <%= text_field_tag :search, params[:sticky_search], class: "search-query", placeholder: "Search Tenant", type: "search", data: {autocomplete: users_autocomplete_user_path }, id: 'tenant_search', style: "margin-left:0px !important;width:50%" %>
                    <h2 style="margin-top: 10px;margin-bottom:10px"><span class="sms_username"></span> <span class="sms_number"></span></h2>
                    <textarea style="width: 50%;height:60px" maxlength="50" id="message"></textarea>
                    <div class="row"><div class="btn" style="margin-left: 20px" id="send_sms">Send</div></div>
                </div>
            </li>
        </ul>
    </li>
</ul>

<script type="text/javascript">   
    $('#example-1').sticklr({
        menuHeight  : 20,
        menuWidth   : 750,
        tabHeight   : 20,
        tabWidth    : 80,
        showOn      : 'hover',
        stickTo     : 'right',
    });

    // $('#search').sticklr({
    //     // animate     : true,
    //     menuHeight  : 20,
    //     menuWidth   : 200,
    //     // relativeTo  : 'bottom',  
    //     // relativeGap : 90,
    //     showOn      : 'hover',
    //     tabHeight   : 34,
    //     tabWidth    : 32
    // });
    
    $("#a_select").click(function(){
        $('#select_number').modal({
        backdrop: 'static',
        keyboard: false
        },'show');
    })

    $('.example-p-2').on('click', function () {
        var destination = $(this).html()
        $.confirm({
            title: 'Call',
            content: 
            '<form action="send_sms" data-remote="true" class="form_control">'+
                '<div class="radio"><input type="radio" value="2018480">2018480 Steve Shop Number</div><br>'+
                '<div class="radio"><input type="radio" value="2018481">2018481 Emma Shop Number</div><br>'+
                '<div class="radio"><input type="radio" value="2018700">2018700 Steve Home Number</div><br>'+
                '<div class="radio"><input type="radio" value="2018701">2018701 Emma Home Number</div>'+
            '</form>',
            confirmButton: 'Proceed',
            confirmButtonClass: 'btn-info',
            icon: 'fa fa-question-circle',
            animation: 'scale',
            animationClose: 'top',
            opacity: 0.5,
            confirm: function () {
                var extension = $('input[type="radio"]:checked').val();
                $.ajax({ 
                    url: "/make_call?extension="+extension+'&destination='+destination,
                    success: function(){ 
                        // $('#select_number').modal("hide");
                    },
                    error:function(){
                        console.log('error')
                    } 
                })
            }
        });
    });

    $("#call_handler").mouseover(function(){
        $.ajax({
            type: 'get',
            url: '/get_call_handler',
            success: function(res){
                console.log(res)
                $("#call_handler").next().find("li").html(res)
            }
        })
    })

    $('#tenant_search').bind('railsAutocomplete.select', function(event, data){
        var user_id = data.item.id
        $.ajax({
            url: '/get_user_data',
            dataType: 'json',
            data: {id: user_id}
        })
        .done(function(res) {
            $('.sms_username').html(res.user.first_name)
            $('.sms_number').html(res.user.phone)
        })
    })

    $("#send_sms").click(function(){
        $(".alert_msg").html("Sending...")
        var number = $(".sms_number").html() 
        var message = $("#message").val()
        $.ajax({
            type: "get",
            url: "/send_sms_to_user",
            data: "number="+number+"&message="+message,
            success: function(res){
                console.log(res.data)
                // alert('Message Sent Successfully.')
                $(".alert_msg").html(res.data)
                setTimeout(function() {
                    $(".alert_msg").slideUp()
                }, 4000);
            }
        })        
    })
</script>

<style type="text/css">
    .ui-autocomplete {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 1000;
      float: left;
      display: none;
      min-width: 160px;
      _width: 160px;
      padding: 4px 0;
      margin: 2px 0 0 0;
      list-style: none;
      background-color: #ffffff;
      border-color: #ccc;
      border-color: rgba(0, 0, 0, 0.2);
      border-style: solid;
      border-width: 1px;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      border-radius: 5px;
      -webkit-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
      -moz-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
      -webkit-background-clip: padding-box;
      -moz-background-clip: padding;
      background-clip: padding-box;
      *border-right-width: 2px;
      *border-bottom-width: 2px;
     
      .ui-menu-item > a.ui-corner-all {
        display: block;
        padding: 3px 15px;
        clear: both;
        font-weight: normal;
        line-height: 18px;
        color: #555555;
        white-space: nowrap;
     
      

      }
    }
    .ui-widget-content .ui-state-focus {
      color: #ffffff;
      text-decoration: none;
      background-color: #0088cc;
      border-radius: 0px;
      -webkit-border-radius: 0px;
      -moz-border-radius: 0px;
      background-image: none;
    }

</style>